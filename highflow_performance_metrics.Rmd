---
title: "High stream flow performance metrics"
author: "Sam Muir & Melissa Widas"
date: "2024-06-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(sensitivity)
library(tidyverse)
library(purrr)
library(ggpubr)
library(patchwork)
library(ggtext)
```

```{r}
# read in data
sager = read.table("sager.txt", header=T)
msage = read.table("sagerm.txt", header=T)
# add date
sager = sager %>% mutate(date = paste(day,month,year, sep="/"))
sager$date = as.Date(sager$date,"%d/%m/%Y")

source("nse.R")
source("relerr.R")
source("cper.R")
```

# High-flow Metrics
```{r}
# turn your evaluation metric into a function
source("compute_highflowmetrics.R")
compute_highflowmetrics

# run highflow metrics
compute_highflowmetrics(m=sager$model,o=sager$obs, month=sager$month, day=sager$day, year=sager$year, wy=sager$wy)

# run highflow metrics across march, april, and may (high flow months)
perf_high = compute_highflowmetrics(m=sager$model,o=sager$obs, month=sager$month, day=sager$day, year=sager$year, wy=sager$wy, high_flow_months = c(3:5))
perf_high
```

# Combined Metric
```{r}
# convert highflow metrics to dataframe
perf_high = as.data.frame(perf_high)

# normalize by max error of 0.4
tmp = sager %>% 
  subset(month %in% c(3:5)) # subset to our high flow months
errmax_high = mean(tmp$obs)*0.4

# add col annual_max_err_trans
perf_high = perf_high %>% 
  mutate(annual_max_err_trans = max(0,(1-abs(annual_max_err/errmax_high) )))
      
# subset to highflow months and get the sum for each month by wy
tmp_high = sager %>% 
  subset(month %in% c(3:5)) %>% # subset to our high flow months
  group_by(wy, month) %>% 
  summarize(obs=sum(obs))

# normalize by 0.4
errmax_high = mean(tmp_high$obs)*0.4

# add col annual_max_err_trans 
perf_high = perf_high %>% 
  mutate(high_month_err_trans = max(0,(1-abs(high_month_err/errmax_high) )))

# combine measures
perf_high = perf_high %>% 
  mutate(combined = (annual_max_cor + annual_max_err_trans + high_month_err_trans + high_month_cor)/4)

# weight each column
perf_high = perf_high %>%
  mutate(combined2 = 0.1*annual_max_cor + 0.1*annual_max_err_trans + 0.4*high_month_err_trans+ 0.4*high_month_cor)

perf_high
```

# Split-sample Calibration
```{r}
# load function
source("compute_highflowmetrics_all.R")

# read in data
msage = read.table("sagerm.txt", header=T)

# number of sims
nsim = ncol(msage)
snames = sprintf("S%d",seq(from=1, to=nsim))
colnames(msage)=snames

# add dates from sager to msage
msage$date = sager$date
msage$month = sager$month
msage$year = sager$year
msage$day = sager$day
msage$wy = sager$wy

# join msage and sager (only obs and date) by date
msage = left_join(msage, sager[,c("obs","date")], by=c("date"))

# make new df and map across using compute_highflowmetrics_all
res = msage %>% 
  select(-date, -month, -day, -year, -wy ) %>% 
  map_df(compute_highflowmetrics_all, o=sager$obs, month=msage$month, day=msage$day, year=msage$year, wy=msage$wy)

summary(res)


# pivot and plot
resl = res %>% 
  pivot_longer(cols=everything(), names_to="metric", values_to="value")

ggplot(resl, aes(metric, value)) +
  geom_boxplot() +
  facet_wrap(~metric, scales="free") +
  theme_bw()

# assign an identifier to each row, use the same identify for columns of original streamflow data
res$run = seq(from=1,to=nrow(res))
res = res %>% 
  filter(run != 102)
# head(msage)
colnames(msage)=c(res$run, "date","month","year","day","wy", "obs")

# extract best & worst one
best = res[which.max(res$combined),]
worst = res[which.min(res$combined),]

# pivot and plot
msagel  =  msage %>% 
  pivot_longer(cols=!c(date, month, year, day,wy), names_to="run", values_to="flow")

ggplot(subset(msagel, run == best$run), aes(date, flow)) + 
  geom_line() +
  labs(x = "Date",
       y = "Flow (mm/day)",
       title = "Monthly Aggregate Daily Maximum Stream Flow for best model run") +
  theme_linedraw()
```

```{r}
# subset for split sample calibration, wy before 1975
short_msage = subset(msage, wy < 1975)

# compute performance measures for output from all parameters
res = short_msage %>% 
  select(!c("date","month","year","day","wy","obs")) %>%
map_dbl(nse, short_msage$obs) 

head(res)

# map across all using compute_highflowmetrics_all for wy before 1975
res = short_msage %>% 
  select(-date, -month, -day, -year, -wy, -obs ) %>%
  map_df(compute_highflowmetrics_all, o=short_msage$obs, month=short_msage$month, day=short_msage$day,
         year=short_msage$year, wy=short_msage$wy)

summary(res)

# add sim numbers for identification
res$sim = snames

# pivot and plot
resl = res %>% 
  pivot_longer(-sim, names_to="metric", values_to="value")
ggplot(resl, aes(metric, value)) +
  geom_boxplot() +
  facet_wrap(~metric, scales="free") +
  theme_bw()
```

### Find the Best & Worst Runs
```{r, fig.width=12}
# read in data
msage = read.table("sagerm.txt", header=T)

# number of sims
nsim = ncol(msage)
snames = sprintf("S%d",seq(from=1, to=nsim))
colnames(msage)=snames

# add dates from sager to msage
msage$date = sager$date
msage$month = sager$month
msage$year = sager$year
msage$day = sager$day
msage$wy = sager$wy

# join msage and sager (only obs and date) by date
msage = left_join(msage, sager[,c("obs","date")], by=c("date"))

# select the best one based on the combined metric
best = res[which.max(res$combined),]

# plot best vs observed daily max stream flow
ggplot(msage) + 
  geom_line(aes(x = date, y = msage[,best$sim]), color = "orange") +
  geom_line(aes(date, obs), color ="purple") +
  labs(title = "<span style='font-size:15pt'>Monthly Aggregate Daily Maximum Stream Flow
    <span style='color:#FFA500;'>Observed</span> and
    <span style='color:#800080;'>Best Simulation</span>
    </span>",
    y = "Flow (mm/day)") +
  theme_bw() +
  theme(plot.title = element_markdown())

# find worst run for comparison
worst = res[which.min(res$combined),]
compruns = msage %>% 
  select(best$sim, worst$sim, date, obs, month, day, year, wy)
```

### Plotting
```{r}
## post calibration (after 1975)
compruns_post = subset(compruns, wy > 1975)
compruns_mwy_post = compruns_post %>% select(-c(day,date, year)) %>% group_by(month, wy) %>%
summarize(across(everything(), mean))
compruns_mwy_post = compruns_mwy_post %>% pivot_longer(cols=!c(month,wy), names_to="sim",
values_to="flow")
post <- compruns_mwy_post %>% 
  subset(month==3) %>% 
  ggplot(aes(sim,flow )) + 
  geom_boxplot() +
  labs(title = "Post-Calibration", y = "March Mean Stream Flow") +
  theme_bw()

## pre calibration (pre 1975)
compruns_pre = subset(compruns, wy < 1975)
compruns_mwy_pre = compruns_pre %>% select(-c(day,date, year)) %>% group_by(month, wy) %>%
summarize(across(everything(), mean))
compruns_mwy_pre = compruns_mwy_pre %>% pivot_longer(cols=!c(month,wy), names_to="sim",
values_to="flow")
pre <- compruns_mwy_pre %>% 
  subset(month==3) %>% 
  ggplot(aes(sim,flow )) +
  geom_boxplot() + 
  labs(title = "Pre-Calibration", y = "March Mean Stream Flow") +
  theme_bw()

pre + post
```

We chose to look at high flow (month with the highest flow rates) because high flow rates can contribute to steam erosion and damage in general. High flow can alter ecological restoration decisions and impact water use regulations. There was high variation in max flow throughout the year, so we determined that March, April, and May generally had the highest flow rates.
